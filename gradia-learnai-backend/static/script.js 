// HTML ìš”ì†Œ ì„ íƒí•˜ê¸°
const uploadBtn = document.getElementById('uploadBtn');        // ì—…ë¡œë“œ ë²„íŠ¼
const fileInput = document.getElementById('fileInput');        // ìˆ¨ê²¨ì§„ íŒŒì¼ ì…ë ¥(input)
const historySection = document.getElementById('historySection');  // í•™ìŠµ ì´ë ¥ ì„¹ì…˜
const stepsSection = document.getElementById('stepsSection');      // ë‹¨ê³„ë³„ ë‚´ìš© ì„¹ì…˜
const stepButtons = document.querySelectorAll('.step-btn');     // ë‹¨ê³„ ì´ë™ ë²„íŠ¼ë“¤
const stepContents = document.querySelectorAll('.step-content'); // ë‹¨ê³„ë³„ ë‚´ìš© ì˜ì—­ë“¤
let currentStep = null;  // í˜„ì¬ í™œì„±í™”ëœ ë‹¨ê³„ (ì—†ìœ¼ë©´ null)

// ì—…ë¡œë“œ ë²„íŠ¼ í´ë¦­í•˜ë©´ íŒŒì¼ ì„ íƒì°½ ì—´ê¸°
uploadBtn.addEventListener('click', () => {
  fileInput.click();  // ìˆ¨ê²¨ì§„ input[type=file] í´ë¦­ ì´ë²¤íŠ¸ ë°œìƒ
});

// íŒŒì¼ì´ ì„ íƒë˜ì—ˆì„ ë•Œ ì²˜ë¦¬
fileInput.addEventListener('change', () => {
  if (fileInput.files.length > 0) {  // íŒŒì¼ì´ í•˜ë‚˜ë¼ë„ ì„ íƒë˜ì—ˆìœ¼ë©´
    const file = fileInput.files[0];  // ì²« ë²ˆì§¸ íŒŒì¼ ì„ íƒ
    const reader = new FileReader(); // íŒŒì¼ì„ ì½ê¸° ìœ„í•œ FileReader ê°ì²´ ìƒì„±

    // íŒŒì¼ ì½ê¸°ê°€ ì™„ë£Œë˜ì—ˆì„ ë•Œ ì‹¤í–‰í•  í•¨ìˆ˜
    reader.onload = (e) => {
      const text = e.target.result; // ì½ì€ íŒŒì¼ ë‚´ìš© (í…ìŠ¤íŠ¸)
      console.log('íŒŒì¼ ë‚´ìš©:', text);

      // 1ë‹¨ê³„ ì˜ì—­ì— íŒŒì¼ì—ì„œ ì½ì€ í…ìŠ¤íŠ¸ ì¼ë¶€ë¥¼ ë³´ì—¬ì£¼ê³  ë²„íŠ¼ ì¶”ê°€
      const step1Div = document.getElementById('step1');
      step1Div.innerHTML = `
        <div class="step-item">íŒŒì¼ì—ì„œ ì½ì€ í…ìŠ¤íŠ¸ ì¼ë¶€: ${text.slice(0, 100)}...</div>
        <div class="step-controls">
          <button onclick="prevStep()">â—€ï¸ ì´ì „ ë‹¨ê³„</button>
          <button onclick="saveProgress(1)">ğŸ’¾ í•™ìŠµ ì´ë ¥ ì €ì¥</button>
        </div>
      `;

      // UI ì „í™˜: í•™ìŠµ ì´ë ¥ ìˆ¨ê¸°ê³  ë‹¨ê³„ë³„ ì„¹ì…˜ ë³´ì—¬ì£¼ê¸°
      historySection.style.display = 'none';
      stepsSection.style.display = 'block';

      // í˜„ì¬ ë‹¨ê³„ë¥¼ 1ë¡œ ì„¤ì •í•˜ê³ , ëª¨ë“  ë‹¨ê³„ ë‚´ìš© ìˆ¨ê¸´ í›„ 1ë‹¨ê³„ë§Œ ë³´ì´ê²Œ ì²˜ë¦¬
      currentStep = '1';
      stepContents.forEach(content => content.classList.remove('active'));
      step1Div.classList.add('active');
    };

    // í…ìŠ¤íŠ¸ íŒŒì¼ë¡œ ì½ê¸° ì‹œì‘
    reader.readAsText(file);
  }
});

// ë‹¨ê³„ ë²„íŠ¼(í‚¤ì›Œë“œ ì¶”ì¶œ, ê°œë… 1, ì •ë¦¬, ê°œë… 2 ë“±) í´ë¦­ ì‹œ í•´ë‹¹ ë‹¨ê³„ ë‚´ìš© í‘œì‹œ
stepButtons.forEach(btn => {
  btn.addEventListener('click', () => {
    const step = btn.getAttribute('data-step'); // ë²„íŠ¼ì— ì§€ì •ëœ ë‹¨ê³„ ë²ˆí˜¸ ì½ê¸°
    // ëª¨ë“  ë‹¨ê³„ ë‚´ìš© ìˆ¨ê¸°ê¸°
    stepContents.forEach(content => content.classList.remove('active'));
    // í´ë¦­í•œ ë‹¨ê³„ë§Œ ë³´ì—¬ì£¼ê¸°
    document.getElementById('step' + step).classList.add('active');
    currentStep = step; // í˜„ì¬ ë‹¨ê³„ ë²ˆí˜¸ ê°±ì‹ 
  });
});

// ì´ì „ ë‹¨ê³„ ë²„íŠ¼ í´ë¦­ ì‹œ í˜„ì¬ ë‹¨ê³„ ìˆ¨ê¸°ê³  currentStep ì´ˆê¸°í™”
function prevStep() {
  if(currentStep) {
    document.getElementById('step' + currentStep).classList.remove('active');
    currentStep = null;
  }
}

// í•™ìŠµ ì´ë ¥ ì €ì¥ ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰ (í˜„ì¬ëŠ” ì•Œë¦¼ì°½ë§Œ ë„ì›€)
function saveProgress(step) {
  alert(`í•™ìŠµ ì´ë ¥ ì €ì¥: ${step}ë‹¨ê³„ ë‚´ìš© ì €ì¥ ê¸°ëŠ¥ êµ¬í˜„ ì˜ˆì •`);
}

// ì¦ê²¨ì°¾ê¸° ë³„ ì•„ì´ì½˜ í† ê¸€ í•¨ìˆ˜
function toggleStar(elem) {
  const isStarred = elem.getAttribute('data-starred') === 'true'; // í˜„ì¬ ìƒíƒœ í™•ì¸
  if(isStarred) {
    elem.setAttribute('data-starred', 'false'); // ìƒíƒœ falseë¡œ ë³€ê²½
    elem.classList.remove('active');            // í™œì„±í™” í´ë˜ìŠ¤ ì œê±°
    elem.textContent = 'â˜†';                      // ë¹ˆ ë³„ë¡œ í‘œì‹œ
  } else {
    elem.setAttribute('data-starred', 'true');  // ìƒíƒœ trueë¡œ ë³€ê²½
    elem.classList.add('active');                // í™œì„±í™” í´ë˜ìŠ¤ ì¶”ê°€
    elem.textContent = 'â­';                      // ê½‰ ì°¬ ë³„ë¡œ í‘œì‹œ
  }
}

// ë©”ëª¨ ì‘ì„± ì°½ í† ê¸€
function toggleMemoBox() {
    const box = document.getElementById("memo-box");
    box.style.display = (box.style.display === "none") ? "block" : "none";
}

// ë©”ëª¨ ì €ì¥ ìš”ì²­
function saveMemo() {
    const content = document.getElementById("memo-content").value;
    if (!content.trim()) {
        alert("ë©”ëª¨ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
        return;
    }

    fetch("/memo", {
        method: "POST",
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            user_id: "user123",  // í•„ìš” ì‹œ ì‹¤ì œ ë¡œê·¸ì¸ ì‚¬ìš©ìë¡œ ë³€ê²½
            document_id: "doc001",  // ì—…ë¡œë“œëœ ë¬¸ì„œ ê³ ìœ  IDë¡œ êµì²´
            keyword: "í‚¤ì›Œë“œ ì˜ˆì‹œ",
            content: content
        })
    })
    .then(res => res.json())
    .then(data => {
        alert(data.message);
        document.getElementById("memo-content").value = "";
        loadMemos(); // ì €ì¥ í›„ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
    });
}

// ì €ì¥ëœ ë©”ëª¨ ë¶ˆëŸ¬ì˜¤ê¸°
function loadMemos() {
    fetch("/memo/user123/doc001")  // ìœ„ì™€ ê°™ì€ IDë¡œ ë§ì¶°ì¤˜
        .then(res => res.json())
        .then(data => {
            const list = document.getElementById("memo-items");
            list.innerHTML = "";
            data.forEach(memo => {
                const li = document.createElement("li");
                li.textContent = `${memo.keyword || "ë©”ëª¨"}: ${memo.content}`;
                list.appendChild(li);
            });
        });
}

// í˜ì´ì§€ ë¡œë”© ì‹œ ë©”ëª¨ ë¶ˆëŸ¬ì˜¤ê¸°
document.addEventListener("DOMContentLoaded", () => {
    loadMemos();
});
